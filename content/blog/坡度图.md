---
title: 坡度图
tags:
categories: R

---

## 普通坡度图

```{r}
library(ggplot2)
data <- structure(list(
  Date = structure(c(1, 1, 1, 1, 1, 2, 2, 2, 2, 2), 
         .Label = c("11-May-19", "18-May-19"), 
         class = "factor"), 
  Party = structure(rep(1:5,2), 
         .Label = c("Green", "Liberal", "NDP", "Others", "PC"), 
         class = "factor"), 
  Pct = c(42.3, 28.4, 22.1, 8.4, 1.8, 37.9, 33.3, 27.3, 5, 8.4)), 
          class = "data.frame", 
          row.names = c(NA, -10L))

ggplot(data = data, aes(x = Date, y = Pct, group = Party,color = Party)) +
  geom_line(size = 2) +
  geom_point(size = 4) +
  annotate('text',x = 2.1,y = c(37.9, 33.3, 27.3, 5, 8.4),
           label = c("Green", "Liberal", "NDP", "Others", "PC"))+
  scale_x_discrete(position = "top") +
  scale_color_brewer(palette = 'Paired')+
  theme_bw() +
  theme(legend.position = 'none') +
  theme(panel.border = element_blank())
```

## 复杂坡度图案例1

[独孤九剑]([jkeirstead/r-slopegraph: Create Edward Tufte style slopegraphs with R and ggplot2 (github.com)](https://github.com/jkeirstead/r-slopegraph))

```{r}
library(dplyr)
theme_set(theme_classic())
source_df <- read.csv("cancer_survival_rates.csv")

# Define functions. Source: https://github.com/jkeirstead/r-slopegraph
tufte_sort <- function(df, x="year", y="value", group="group", 
                       method="tufte", min.space=0.05) {
  ## First rename the columns for consistency
  ids <- match(c(x, y, group), names(df))
  df <- df[,ids]
  names(df) <- c("x", "y", "group")

  ## Expand grid to ensure every combination has a defined value
  tmp <- expand.grid(x=unique(df$x), group=unique(df$group))
  tmp <- merge(df, tmp, all.y=TRUE)
  df <- mutate(tmp, y=ifelse(is.na(y), 0, y))

  ## Cast into a matrix shape and arrange by first column
  require(reshape2)
  tmp <- dcast(df, group ~ x, value.var="y")
  ord <- order(tmp[,2])
  tmp <- tmp[ord,]

  min.space <- min.space*diff(range(tmp[,-1]))
  yshift <- numeric(nrow(tmp))
  for (i in 2:nrow(tmp)) {
    mat <- as.matrix(tmp[(i-1):i, -1])
    d.min <- min(diff(mat))
    yshift[i] <- ifelse(d.min < min.space, min.space - d.min, 0)
  }
  tmp <- cbind(tmp, yshift=cumsum(yshift))
  scale <- 1
  tmp <- melt(tmp, id=c("group", "yshift"), variable.name="x", value.name="y")
  tmp <- transform(tmp, ypos=y + scale*yshift)
  return(tmp)
}
#code 28续
plot_slopegraph <- function(df) {
  ylabs <- subset(df, x==head(x,1))$group
  yvals <- subset(df, x==head(x,1))$ypos
  fontSize <- 3
  gg <- ggplot(df,aes(x=x,y=ypos)) +
    geom_line(aes(group=group),colour="grey80") +
    geom_point(colour="white",size=8) +
    geom_text(aes(label=y), size=fontSize) +
    scale_y_continuous(name="", breaks=yvals, labels=ylabs)
  return(gg)
}    

## Prepare data    
df <- tufte_sort(source_df, 
                 x="year", 
                 y="value", 
                 group="group", 
                 method="tufte", 
                 min.space=0.05)

df <- transform(df, 
                x=factor(x, levels=c(5,10,15,20), 
                         labels=c("5 years","10 years",
                                  "15 years","20 years")), 
                y=round(y))

## Plot
plot_slopegraph(df) + labs(title="Estimates of % survival rates") + 
  scale_x_discrete(expand = expand_scale(mult = 0.1))+
  theme(axis.title=element_blank(),
        axis.ticks = element_blank(),
        plot.title = element_text(hjust=0.5,
                                  face="bold"),
        axis.text = element_text(face="bold"))
```

## 其他

[简书链接](https://www.jianshu.com/p/2aab549c804e)

```{r}
library(ggplot2)
library(reshape2)

data <- read.table("clipboard",header=T,sep='\t')
colnames(data) <- c("class", "2014", "2021")

left_label <- paste(data$class, round(data$'2014'),sep=",")
right_label <- paste(data$class, round(data$'2021'),sep=",")
data$class <- ifelse((data$'2021' - data$'2014') < 0, "red", "green")
(p <- ggplot(data) +
  geom_segment(aes(x=1, xend=2, y=`2014`, yend=`2021`, col=class), size=.75, show.legend=F) + #连接线
  geom_vline(xintercept=1, linetype="solid", size=.1) + # 1952 年的垂直直线
  geom_vline(xintercept=2, linetype="solid", size=.1) + # 1957 年的垂直直线
  geom_point(aes(x=1, y=`2014`), size=3,shape=21,fill="grey80",color="black") + # 1952 年的数据点
  geom_point(aes(x=2, y=`2021`), size=3,shape=21,fill="grey80",color="black") + # 1957 年的数据点
  scale_color_manual(labels = c("Up", "Down"), values = c("green"="blue","red"="red")) +
  xlim(.5, 2.5)+ylim(0,4000))
# 添加文本信息
(p <- p + geom_text(label=left_label, y=data$`2014`, x=rep(1, 15), hjust=1.1, size=3.5))
(p <- p + geom_text(label=right_label, y=data$`2021`, x=rep(2, 15), hjust=-0.1, size=3.5))
(p <- p + geom_text(label="2014", x=1, y=1.08*(max(data$`2014`, data$`2021`)), hjust=1.2, size=5))
(p <- p + geom_text(label="2021", x=2, y=1.08*(max(data$`2014`, data$`2021`)), hjust=-0.1, size=5))
(p<-p+theme_void())
```
